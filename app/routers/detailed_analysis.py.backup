from fastapi import APIRouter, HTTPException
from fastapi.responses import HTMLResponse
import os
import pandas as pd
import numpy as np
import json
from app.utils import storage

router = APIRouter()

@router.get("/detailed-analysis/{file_id}", response_class=HTMLResponse)
async def get_detailed_analysis(file_id: str):
    """
    Genera una p√°gina HTML educativa que muestra paso a paso c√≥mo funciona el modelo XGBoost
    Estilo 'Pedro el Ingeniero' - explicaciones visuales y did√°cticas
    """

    # Buscar el archivo
    file_data = storage.get_file(file_id)
    if not file_data:
        raise HTTPException(status_code=404, detail="Archivo no encontrado")

    # Buscar an√°lisis del archivo
    analyses = storage.get_analyses_by_file(file_id)
    if not analyses:
        raise HTTPException(status_code=404, detail="No hay an√°lisis disponibles para este archivo")

    # Obtener el √∫ltimo an√°lisis
    latest_analysis = analyses[-1]

    # Cargar el dataframe original
    file_path = file_data['file_path']
    if not os.path.exists(file_path):
        raise HTTPException(status_code=404, detail="Archivo de datos no encontrado")

    # Leer el archivo
    if file_path.endswith('.xlsx') or file_path.endswith('.xls'):
        df = pd.read_excel(file_path)
    elif file_path.endswith('.csv'):
        df = pd.read_csv(file_path)
    else:
        raise HTTPException(status_code=400, detail="Formato de archivo no soportado")

    # Obtener estad√≠sticas b√°sicas
    total_records = len(df)
    columns_count = len(df.columns)
    columns_list = list(df.columns)

    # Distribuci√≥n de diagn√≥sticos
    if 'Diagnostico' in df.columns:
        diagnosis_dist = df['Diagnostico'].value_counts().to_dict()
    else:
        diagnosis_dist = {}

    # Estad√≠sticas num√©ricas
    numeric_stats = {}
    for col in df.select_dtypes(include=[np.number]).columns:
        numeric_stats[col] = {
            'mean': float(df[col].mean()),
            'min': float(df[col].min()),
            'max': float(df[col].max()),
            'std': float(df[col].std())
        }

    # Generar HTML educativo
    html_content = generate_educational_html(
        file_name=file_data['original_filename'],
        total_records=total_records,
        columns_count=columns_count,
        columns_list=columns_list,
        diagnosis_dist=diagnosis_dist,
        numeric_stats=numeric_stats,
        analysis_results=latest_analysis
    )

    return HTMLResponse(content=html_content)


def generate_educational_html(file_name, total_records, columns_count, columns_list, diagnosis_dist, numeric_stats, analysis_results):
    """
    Genera el HTML educativo paso a paso estilo 'Pedro el Ingeniero'
    """

    # Calcular m√©tricas del an√°lisis
    accuracy = analysis_results.get('accuracy', 0) * 100
    f1_score = analysis_results.get('f1_score', 0) * 100

    html = f"""
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Detallado - {file_name}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}

        body {{
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            padding: 40px 20px;
            line-height: 1.7;
        }}

        .container {{
            max-width: 1100px;
            margin: 0 auto;
        }}

        .header {{
            text-align: center;
            margin-bottom: 60px;
            padding: 50px 40px;
            background: #141414;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }}

        .header h1 {{
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: #ffffff;
            font-weight: 600;
            letter-spacing: -0.02em;
        }}

        .header p {{
            font-size: 1.1rem;
            color: #a0a0a0;
            font-weight: 400;
        }}

        .step-card {{
            background: #141414;
            color: #e5e5e5;
            padding: 40px;
            margin-bottom: 24px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s ease;
        }}

        .step-card:hover {{
            border-color: #3a3a3a;
        }}

        .step-number {{
            position: absolute;
            top: -12px;
            left: 30px;
            width: 56px;
            height: 56px;
            background: #1e1e1e;
            color: #ffffff;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            border: 1px solid #2a2a2a;
        }}

        .step-content {{
            margin-top: 30px;
        }}

        .step-title {{
            font-size: 1.75rem;
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }}

        .step-title i {{
            font-size: 1.75rem;
            color: #a0a0a0;
        }}

        .explanation {{
            font-size: 1rem;
            line-height: 1.75;
            margin-bottom: 24px;
            padding: 20px;
            background: #1a1a1a;
            border-left: 3px solid #3a3a3a;
            border-radius: 8px;
            color: #d0d0d0;
        }}

        .analogy {{
            background: #1e1e1e;
            color: #e5e5e5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 3px solid #3a3a3a;
        }}

        .analogy-title {{
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ffffff;
        }}

        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }}

        .stat-box {{
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #e5e5e5;
            padding: 24px;
            border-radius: 10px;
            text-align: center;
        }}

        .stat-value {{
            font-size: 2.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }}

        .stat-label {{
            font-size: 0.875rem;
            color: #a0a0a0;
            font-weight: 400;
        }}

        .code-box {{
            background: #0d0d0d;
            color: #d0d0d0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid #2a2a2a;
        }}

        .process-flow {{
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 12px;
        }}

        .flow-item {{
            flex: 1;
            min-width: 140px;
            background: #1e1e1e;
            color: #e5e5e5;
            padding: 18px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
            border: 1px solid #2a2a2a;
        }}

        .flow-arrow {{
            color: #5a5a5a;
            font-size: 1.5rem;
            margin: 0 8px;
        }}

        .feature-list {{
            list-style: none;
            padding: 0;
        }}

        .feature-item {{
            padding: 14px 16px;
            margin: 8px 0;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #e5e5e5;
        }}

        .feature-item i {{
            color: #a0a0a0;
            font-size: 1.25rem;
        }}

        .highlight {{
            background: #1e1e1e;
            padding: 2px 6px;
            border-radius: 4px;
            color: #ffffff;
            font-weight: 500;
            border: 1px solid #3a3a3a;
        }}

        .warning-box {{
            background: #2a2410;
            color: #ffc107;
            padding: 18px;
            border-radius: 8px;
            border-left: 3px solid #ffc107;
            margin: 20px 0;
        }}

        .success-box {{
            background: #1a2e1a;
            color: #4ade80;
            padding: 18px;
            border-radius: 8px;
            border-left: 3px solid #4ade80;
            margin: 20px 0;
        }}

        .comparison-table {{
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #2a2a2a;
        }}

        .comparison-table th {{
            background: #1e1e1e;
            color: #ffffff;
            padding: 14px;
            text-align: left;
            font-weight: 600;
        }}

        .comparison-table td {{
            padding: 14px;
            border-bottom: 1px solid #2a2a2a;
            font-size: 0.9rem;
            color: #e5e5e5;
        }}

        .comparison-table tr:hover {{
            background: #1e1e1e;
        }}

        @media (max-width: 768px) {{
            .header h1 {{
                font-size: 1.75rem;
            }}

            .step-title {{
                font-size: 1.4rem;
            }}

            .process-flow {{
                flex-direction: column;
            }}

            .flow-arrow {{
                transform: rotate(90deg);
            }}

            .stat-box {{
                padding: 18px;
            }}

            .stat-value {{
                font-size: 2rem;
            }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-brain"></i> An√°lisis Detallado del Modelo XGBoost</h1>
            <p>Entendiendo el proceso paso a paso - Estilo educativo</p>
            <p style="font-size: 1rem; margin-top: 10px; opacity: 0.8;">Archivo: <strong>{file_name}</strong></p>

            <button onclick="toggleXGBoostProcess()" class="xgboost-btn" id="xgboostBtn">
                <i class="fas fa-play-circle"></i> Ver Procedimiento XGBoost Animado
            </button>
        </div>

        <!-- SECCI√ìN ANIMADA DEL PROCEDIMIENTO XGBOOST -->
        <div id="xgboostProcess" class="xgboost-process-container" style="display: none;">
            <div class="process-header">
                <h2><i class="fas fa-code-branch"></i> Proceso Interno de XGBoost</h2>
                <p>Visualizaci√≥n paso a paso del algoritmo de Gradient Boosting</p>
            </div>

            <!-- PASO 1: ENTRADA DE DATOS -->
            <div class="animated-step" data-step="1">
                <div class="step-visual">
                    <div class="data-input">
                        <div class="data-point" style="animation-delay: 0s;"></div>
                        <div class="data-point" style="animation-delay: 0.1s;"></div>
                        <div class="data-point" style="animation-delay: 0.2s;"></div>
                        <div class="data-point" style="animation-delay: 0.3s;"></div>
                        <div class="data-point" style="animation-delay: 0.4s;"></div>
                    </div>
                    <div class="arrow-flow">‚Üí</div>
                    <div class="process-box">
                        <i class="fas fa-database"></i>
                        <span>Dataset<br>{total_records:,} registros</span>
                    </div>
                </div>
                <div class="step-explanation">
                    <h3>1. Recepci√≥n de Datos</h3>
                    <p>XGBoost recibe los datos de entrada con todas las caracter√≠sticas (edad, glucosa, presi√≥n, etc.)</p>
                </div>
            </div>

            <!-- PASO 2: C√ÅLCULO DE RESIDUOS INICIALES -->
            <div class="animated-step" data-step="2">
                <div class="step-visual">
                    <div class="formula-box">
                        <div class="formula-line">
                            <span class="formula-label">Predicci√≥n inicial:</span>
                            <span class="formula-value">≈∑<sub>0</sub> = promedio(y)</span>
                        </div>
                        <div class="formula-line">
                            <span class="formula-label">Error residual:</span>
                            <span class="formula-value">r<sub>i</sub> = y<sub>i</sub> - ≈∑<sub>0</sub></span>
                        </div>
                    </div>
                </div>
                <div class="step-explanation">
                    <h3>2. C√°lculo de Residuos Iniciales</h3>
                    <p>El modelo comienza con una predicci√≥n simple (promedio) y calcula qu√© tan lejos est√° de la realidad.</p>
                </div>
            </div>

            <!-- PASO 3: CONSTRUCCI√ìN ITERATIVA DE √ÅRBOLES -->
            <div class="animated-step" data-step="3">
                <div class="step-visual">
                    <div class="trees-container">
                        <div class="tree-item" style="animation-delay: 0s;">
                            <div class="tree-icon">üå≥</div>
                            <div class="tree-label">√Årbol 1</div>
                            <div class="tree-weight">Œ±‚ÇÅ</div>
                        </div>
                        <div class="plus-symbol">+</div>
                        <div class="tree-item" style="animation-delay: 0.5s;">
                            <div class="tree-icon">üå≥</div>
                            <div class="tree-label">√Årbol 2</div>
                            <div class="tree-weight">Œ±‚ÇÇ</div>
                        </div>
                        <div class="plus-symbol">+</div>
                        <div class="tree-item" style="animation-delay: 1s;">
                            <div class="tree-icon">üå≥</div>
                            <div class="tree-label">√Årbol 3</div>
                            <div class="tree-weight">Œ±‚ÇÉ</div>
                        </div>
                        <div class="plus-symbol">+</div>
                        <div class="ellipsis">...</div>
                        <div class="plus-symbol">+</div>
                        <div class="tree-item" style="animation-delay: 1.5s;">
                            <div class="tree-icon">üå≥</div>
                            <div class="tree-label">√Årbol 300</div>
                            <div class="tree-weight">Œ±‚ÇÉ‚ÇÄ‚ÇÄ</div>
                        </div>
                    </div>
                </div>
                <div class="step-explanation">
                    <h3>3. Construcci√≥n Secuencial de 300 √Årboles</h3>
                    <p>Cada √°rbol nuevo aprende a corregir los errores del √°rbol anterior. Este es el "Boosting".</p>
                    <div class="mini-formula">
                        F<sub>m</sub>(x) = F<sub>m-1</sub>(x) + Œ∑ ¬∑ h<sub>m</sub>(x)
                    </div>
                </div>
            </div>

            <!-- PASO 4: GRADIENTE Y OPTIMIZACI√ìN -->
            <div class="animated-step" data-step="4">
                <div class="step-visual">
                    <div class="gradient-visual">
                        <div class="gradient-curve">
                            <svg width="300" height="150" viewBox="0 0 300 150">
                                <path d="M 0,140 Q 75,10 150,75 T 300,20" stroke="#667eea" stroke-width="3" fill="none">
                                    <animate attributeName="stroke-dashoffset" from="1000" to="0" dur="2s" repeatCount="indefinite"/>
                                </path>
                                <circle cx="150" cy="75" r="8" fill="#f5576c">
                                    <animate attributeName="cy" values="75;30;75" dur="2s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                        </div>
                        <div class="gradient-label">
                            <i class="fas fa-arrow-down"></i>
                            Descendiendo por el gradiente
                        </div>
                    </div>
                </div>
                <div class="step-explanation">
                    <h3>4. Descenso de Gradiente</h3>
                    <p>XGBoost usa el gradiente (derivada) de la funci√≥n de p√©rdida para saber en qu√© direcci√≥n optimizar.</p>
                    <div class="mini-formula">
                        g<sub>i</sub> = ‚àÇL/‚àÇ≈∑<sub>i</sub>, &nbsp; h<sub>i</sub> = ‚àÇ¬≤L/‚àÇ≈∑<sub>i</sub>¬≤
                    </div>
                </div>
            </div>

            <!-- PASO 5: REGULARIZACI√ìN -->
            <div class="animated-step" data-step="5">
                <div class="step-visual">
                    <div class="regularization-demo">
                        <div class="overfitting-tree">
                            <div class="tree-complex">‚ùå Sobreajuste</div>
                            <div class="complexity-indicator">Alta complejidad</div>
                        </div>
                        <div class="arrow-transform">‚Üí Regularizaci√≥n ‚Üí</div>
                        <div class="balanced-tree">
                            <div class="tree-simple">‚úÖ Balanceado</div>
                            <div class="complexity-indicator">Complejidad √≥ptima</div>
                        </div>
                    </div>
                </div>
                <div class="step-explanation">
                    <h3>5. Regularizaci√≥n (Œª y Œ≥)</h3>
                    <p>Se a√±aden penalizaciones para evitar que el modelo sea demasiado complejo y memorice en vez de aprender.</p>
                    <div class="mini-formula">
                        Œ©(f) = Œ≥T + ¬ΩŒª||w||¬≤
                    </div>
                </div>
            </div>

            <!-- PASO 6: PREDICCI√ìN FINAL -->
            <div class="animated-step" data-step="6">
                <div class="step-visual">
                    <div class="prediction-flow">
                        <div class="input-box">
                            <i class="fas fa-user"></i>
                            <span>Paciente nuevo</span>
                        </div>
                        <div class="arrow-flow">‚Üí</div>
                        <div class="ensemble-box">
                            <div class="mini-tree">üå≥</div>
                            <div class="mini-tree">üå≥</div>
                            <div class="mini-tree">üå≥</div>
                            <div class="ensemble-label">300 √°rboles</div>
                        </div>
                        <div class="arrow-flow">‚Üí</div>
                        <div class="voting-box">
                            <i class="fas fa-vote-yea"></i>
                            <span>Œ£ votos</span>
                        </div>
                        <div class="arrow-flow">‚Üí</div>
                        <div class="output-box pulsing">
                            <i class="fas fa-check-circle"></i>
                            <span>Diagn√≥stico</span>
                        </div>
                    </div>
                </div>
                <div class="step-explanation">
                    <h3>6. Predicci√≥n Final por Ensemble</h3>
                    <p>La predicci√≥n final es la suma ponderada de todos los √°rboles.</p>
                    <div class="mini-formula">
                        ≈∑<sub>i</sub> = Œ£<sub>k=1</sub><sup>300</sup> f<sub>k</sub>(x<sub>i</sub>)
                    </div>
                </div>
            </div>

            <div class="process-footer">
                <button onclick="toggleXGBoostProcess()" class="close-process-btn">
                    <i class="fas fa-times-circle"></i> Cerrar Procedimiento
                </button>
            </div>
        </div>

        <!-- PASO 1: CARGA DE DATOS -->
        <div class="step-card">
            <div class="step-number">1</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-file-upload"></i>
                    Carga de Datos
                </h2>

                <div class="explanation">
                    <strong>¬øQu√© sucedi√≥ aqu√≠?</strong><br>
                    El sistema ley√≥ tu archivo Excel y carg√≥ <span class="highlight">{total_records:,} registros</span>
                    de pacientes con <span class="highlight">{columns_count} caracter√≠sticas</span> diferentes.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Imagina que tienes una biblioteca con {total_records:,} fichas m√©dicas. Cada ficha tiene {columns_count} campos
                    (como nombre, edad, presi√≥n arterial, etc.). El modelo lee todas estas fichas para aprender patrones.
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">{total_records:,}</div>
                        <div class="stat-label">Registros totales</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{columns_count}</div>
                        <div class="stat-label">Caracter√≠sticas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{len(diagnosis_dist)}</div>
                        <div class="stat-label">Diagn√≥sticos √∫nicos</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; color: #667eea;">Columnas detectadas:</h3>
                <ul class="feature-list">
                    {generate_column_items(columns_list[:10])}
                    {f'<li class="feature-item"><i class="fas fa-ellipsis-h"></i> Y {len(columns_list) - 10} columnas m√°s...</li>' if len(columns_list) > 10 else ''}
                </ul>
            </div>
        </div>

        <!-- PASO 2: PREPROCESAMIENTO -->
        <div class="step-card">
            <div class="step-number">2</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-broom"></i>
                    Limpieza y Preprocesamiento
                </h2>

                <div class="explanation">
                    <strong>¬øPor qu√© es necesario esto?</strong><br>
                    Los modelos de Machine Learning no entienden texto como "Masculino" o "Femenino".
                    Necesitamos convertir todo a n√∫meros y crear nuevas caracter√≠sticas √∫tiles.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Es como preparar ingredientes antes de cocinar. No puedes cocinar con huevos sin c√°scara,
                    ¬øverdad? Aqu√≠ "pelamos" los datos: convertimos texto a n√∫meros, eliminamos valores raros,
                    y creamos nuevas medidas √∫tiles (como calcular el IMC a partir de peso y altura).
                </div>

                <h3 style="margin-top: 30px; color: #667eea;">Transformaciones realizadas:</h3>

                <div class="process-flow">
                    <div class="flow-item">Datos crudos</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item">Convertir texto a n√∫meros</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item">Crear nuevas features</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item">Datos listos</div>
                </div>

                <div class="code-box">
                    <strong>Ejemplo de transformaci√≥n:</strong><br><br>
                    Sexo: "Masculino" ‚Üí 1<br>
                    Sexo: "Femenino" ‚Üí 0<br><br>
                    IMC = Peso (kg) / (Altura (m))¬≤<br>
                    Edad > 60 ‚Üí Adulto_Mayor = 1
                </div>

                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-triangle"></i> Importante:</strong><br>
                    Tambi√©n se eliminaron valores imposibles (como edades negativas o presiones de 0 mmHg)
                    para que el modelo aprenda correctamente.
                </div>
            </div>
        </div>

        <!-- PASO 3: DIVISI√ìN DE DATOS -->
        <div class="step-card">
            <div class="step-number">3</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-cut"></i>
                    Divisi√≥n: Entrenamiento vs Prueba
                </h2>

                <div class="explanation">
                    <strong>¬øPor qu√© dividir los datos?</strong><br>
                    Usamos el <span class="highlight">80%</span> de los datos para ense√±ar al modelo,
                    y guardamos el <span class="highlight">20%</span> para probarlo despu√©s.
                    Es como hacer un examen: no puedes usar las mismas preguntas que usaste para estudiar.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Imagina que est√°s ense√±ando a un ni√±o a reconocer frutas. Le muestras 80 manzanas para que aprenda,
                    pero guardas 20 manzanas que nunca ha visto. Luego, le muestras esas 20 para ver si realmente aprendi√≥
                    o solo memoriz√≥ las primeras 80.
                </div>

                <div class="stats-grid">
                    <div class="stat-box" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                        <div class="stat-value">{int(total_records * 0.8):,}</div>
                        <div class="stat-label" style="color: #ffffff; font-weight: 600;">Datos de entrenamiento (80%)</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #eb3349, #f45c43);">
                        <div class="stat-value">{int(total_records * 0.2):,}</div>
                        <div class="stat-label" style="color: #ffffff; font-weight: 600;">Datos de prueba (20%)</div>
                    </div>
                </div>

                <div class="success-box">
                    <strong><i class="fas fa-check-circle"></i> Buena pr√°ctica:</strong><br>
                    Esta divisi√≥n se hace de forma <strong>aleatoria</strong> pero <strong>estratificada</strong>,
                    lo que significa que mantenemos la misma proporci√≥n de cada diagn√≥stico en ambos grupos.
                </div>
            </div>
        </div>

        <!-- PASO 4: BALANCEO CON SMOTE -->
        <div class="step-card">
            <div class="step-number">4</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-balance-scale"></i>
                    Balanceo de Clases (SMOTE)
                </h2>

                <div class="explanation">
                    <strong>¬øQu√© es SMOTE?</strong><br>
                    SMOTE (Synthetic Minority Over-sampling Technique) es una t√©cnica que <strong>crea ejemplos sint√©ticos</strong>
                    de las clases minoritarias para balancear el dataset.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Imagina que tienes 1000 fotos de gatos y solo 100 de perros. Si entrenas un modelo as√≠,
                    aprender√° a decir "gato" casi siempre. SMOTE crea 900 fotos sint√©ticas de perros (no copias,
                    sino nuevas combinaciones realistas) para que el modelo aprenda ambos por igual.
                </div>

                <div class="process-flow">
                    <div class="flow-item" style="background: #e74c3c;">Clases desbalanceadas</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item" style="background: #f39c12;">SMOTE genera ejemplos sint√©ticos</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item" style="background: #27ae60;">Clases balanceadas</div>
                </div>

                <div class="code-box">
                    <strong>C√≥mo funciona SMOTE:</strong><br><br>
                    1. Toma un ejemplo de la clase minoritaria<br>
                    2. Encuentra sus vecinos m√°s cercanos<br>
                    3. Crea un nuevo ejemplo "intermedio" entre ellos<br>
                    4. Repite hasta balancear las clases
                </div>
            </div>
        </div>

        <!-- PASO 5: ENTRENAMIENTO XGBOOST -->
        <div class="step-card">
            <div class="step-number">5</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-brain"></i>
                    Entrenamiento del Modelo XGBoost
                </h2>

                <div class="explanation">
                    <strong>¬øQu√© es XGBoost?</strong><br>
                    XGBoost (eXtreme Gradient Boosting) es un algoritmo que crea <span class="highlight">300 √°rboles de decisi√≥n</span>
                    que trabajan en equipo. Cada √°rbol aprende de los errores del anterior.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Imagina 300 m√©dicos especializados votando un diagn√≥stico. El primer m√©dico hace su predicci√≥n,
                    el segundo ve d√≥nde se equivoc√≥ el primero y corrige, el tercero mejora sobre los dos anteriores,
                    y as√≠ sucesivamente. Al final, los 300 votan y la mayor√≠a gana. ¬°Por eso es tan preciso!
                </div>

                <h3 style="margin-top: 30px; color: #667eea;">Configuraci√≥n del modelo:</h3>

                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Par√°metro</th>
                            <th>Valor</th>
                            <th>¬øQu√© significa?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>n_estimators</strong></td>
                            <td>300</td>
                            <td>N√∫mero de √°rboles de decisi√≥n</td>
                        </tr>
                        <tr>
                            <td><strong>learning_rate</strong></td>
                            <td>0.05</td>
                            <td>Qu√© tan r√°pido aprende (bajo = m√°s cuidadoso)</td>
                        </tr>
                        <tr>
                            <td><strong>max_depth</strong></td>
                            <td>8</td>
                            <td>Profundidad m√°xima de cada √°rbol</td>
                        </tr>
                        <tr>
                            <td><strong>subsample</strong></td>
                            <td>0.8</td>
                            <td>Usa 80% de datos en cada √°rbol (evita sobreajuste)</td>
                        </tr>
                        <tr>
                            <td><strong>colsample_bytree</strong></td>
                            <td>0.8</td>
                            <td>Usa 80% de caracter√≠sticas en cada √°rbol</td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-triangle"></i> Importante:</strong><br>
                    Estos par√°metros fueron elegidos cuidadosamente para maximizar la precisi√≥n sin sobreajustar.
                    Un modelo "sobreajustado" es como un estudiante que memoriza respuestas en vez de entender conceptos.
                </div>
            </div>
        </div>

        <!-- PASO 6: VALIDACI√ìN CRUZADA -->
        <div class="step-card">
            <div class="step-number">6</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-check-double"></i>
                    Validaci√≥n Cruzada (5-Fold)
                </h2>

                <div class="explanation">
                    <strong>¬øQu√© es la validaci√≥n cruzada?</strong><br>
                    El modelo se entrena y eval√∫a <span class="highlight">5 veces diferentes</span>
                    usando distintas particiones de datos. Luego se promedian los resultados.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Es como tomar 5 ex√°menes diferentes en lugar de solo 1. Divide los datos en 5 partes,
                    usa 4 partes para entrenar y 1 para evaluar. Repite esto 5 veces (cada vez con una parte diferente
                    como evaluaci√≥n). As√≠ tienes una medida m√°s confiable de qu√© tan bien funciona el modelo.
                </div>

                <div class="process-flow">
                    <div class="flow-item">Dividir en 5 partes</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item">Entrenar 5 veces</div>
                    <div class="flow-arrow"><i class="fas fa-arrow-right"></i></div>
                    <div class="flow-item">Promediar resultados</div>
                </div>

                <div class="success-box">
                    <strong><i class="fas fa-check-circle"></i> Beneficio:</strong><br>
                    Esto nos da una estimaci√≥n m√°s realista y confiable del rendimiento del modelo.
                    Si funciona bien en las 5 pruebas, sabemos que es robusto.
                </div>
            </div>
        </div>

        <!-- PASO 7: PREDICCIONES -->
        <div class="step-card">
            <div class="step-number">7</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-magic"></i>
                    Hacer Predicciones
                </h2>

                <div class="explanation">
                    <strong>¬øC√≥mo predice el modelo?</strong><br>
                    Una vez entrenado, el modelo toma los datos del 20% que guardamos (que nunca ha visto)
                    y predice el diagn√≥stico de cada paciente.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    El modelo ya "estudi√≥" con el 80% de casos. Ahora le muestras casos nuevos (el 20% restante)
                    y le preguntas: "¬øEste paciente tiene diabetes, hipertensi√≥n o est√° normal?".
                    El modelo analiza edad, glucosa, presi√≥n, etc., y da su respuesta.
                </div>

                <div class="code-box">
                    <strong>Ejemplo de predicci√≥n:</strong><br><br>
                    Paciente: Edad=55, Glucosa=140, Presi√≥n=150, IMC=32<br><br>

                    √Årbol 1: "Creo que es Hipertensi√≥n" (80% confianza)<br>
                    √Årbol 2: "Creo que es Hipertensi√≥n" (75% confianza)<br>
                    √Årbol 3: "Creo que es Diabetes" (60% confianza)<br>
                    ...<br>
                    √Årbol 300: "Creo que es Hipertensi√≥n" (85% confianza)<br><br>

                    <strong>Votaci√≥n final: Hipertensi√≥n ‚úì</strong>
                </div>
            </div>
        </div>

        <!-- PASO 8: EVALUACI√ìN -->
        <div class="step-card">
            <div class="step-number">8</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-chart-line"></i>
                    Evaluaci√≥n del Rendimiento
                </h2>

                <div class="explanation">
                    <strong>¬øC√≥mo sabemos si es bueno?</strong><br>
                    Comparamos las predicciones del modelo con los diagn√≥sticos reales y calculamos m√©tricas de rendimiento.
                </div>

                <div class="stats-grid">
                    <div class="stat-box" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <div class="stat-value">{accuracy:.1f}%</div>
                        <div class="stat-label" style="color: #ffffff; font-weight: 600;">Precisi√≥n (Accuracy)</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <div class="stat-value">{f1_score:.1f}%</div>
                        <div class="stat-label" style="color: #ffffff; font-weight: 600;">F1-Score</div>
                    </div>
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        ¬øQu√© significan estas m√©tricas?
                    </div>
                    <strong>Precisi√≥n (Accuracy):</strong> De 100 predicciones, {accuracy:.0f} fueron correctas.<br><br>
                    <strong>F1-Score:</strong> Es un promedio balanceado que considera tanto aciertos como errores.
                    Un F1 alto significa que el modelo no solo acierta mucho, sino que tambi√©n evita errores graves.
                </div>

                <h3 style="margin-top: 30px; color: #667eea;">Matriz de Confusi√≥n:</h3>
                <div class="explanation">
                    La matriz de confusi√≥n muestra exactamente qu√© predijo el modelo vs qu√© era la realidad.
                    Los valores en la diagonal (arriba-izquierda a abajo-derecha) son los <strong>aciertos</strong>.
                    Los dem√°s son <strong>errores</strong>.
                </div>

                <div class="success-box">
                    <strong><i class="fas fa-trophy"></i> Resultado:</strong><br>
                    Con una precisi√≥n de <strong>{accuracy:.1f}%</strong>, este modelo est√° listo para ayudar
                    en la detecci√≥n temprana de diabetes e hipertensi√≥n.
                    {get_performance_message(accuracy)}
                </div>
            </div>
        </div>

        <!-- PASO 9: IMPORTANCIA DE CARACTER√çSTICAS -->
        <div class="step-card">
            <div class="step-number">9</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-star"></i>
                    Caracter√≠sticas M√°s Importantes
                </h2>

                <div class="explanation">
                    <strong>¬øQu√© caracter√≠sticas influyeron m√°s?</strong><br>
                    XGBoost puede decirnos cu√°les variables fueron m√°s importantes para hacer predicciones.
                </div>

                <div class="analogy">
                    <div class="analogy-title">
                        <i class="fas fa-lightbulb"></i>
                        Analog√≠a simple:
                    </div>
                    Es como preguntarle al modelo: "¬øEn qu√© te fijaste m√°s para decidir?".
                    El modelo responde: "Me fij√© principalmente en la glucosa, luego en la presi√≥n arterial,
                    luego en la edad, etc." Esto nos ayuda a entender qu√© factores son m√°s predictivos.
                </div>

                <div class="warning-box">
                    <strong><i class="fas fa-info-circle"></i> Nota m√©dica:</strong><br>
                    Las caracter√≠sticas m√°s importantes seg√∫n el modelo coinciden con el conocimiento m√©dico:
                    niveles altos de glucosa predicen diabetes, presi√≥n arterial alta predice hipertensi√≥n, etc.
                </div>
            </div>
        </div>

        <!-- PASO 10: REPORTE FINAL -->
        <div class="step-card">
            <div class="step-number">10</div>
            <div class="step-content">
                <h2 class="step-title">
                    <i class="fas fa-file-pdf"></i>
                    Generaci√≥n del Reporte PDF
                </h2>

                <div class="explanation">
                    <strong>¬øQu√© incluye el reporte?</strong><br>
                    El sistema genera un PDF profesional con todas las visualizaciones, estad√≠sticas y conclusiones del an√°lisis.
                </div>

                <ul class="feature-list">
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Portada profesional con identificador √∫nico</span>
                    </li>
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Resumen ejecutivo con estad√≠sticas clave</span>
                    </li>
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Gr√°ficos de distribuci√≥n y tendencias</span>
                    </li>
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Matriz de confusi√≥n del modelo</span>
                    </li>
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Importancia de caracter√≠sticas (Top 10)</span>
                    </li>
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>An√°lisis de comorbilidades</span>
                    </li>
                    <li class="feature-item">
                        <i class="fas fa-check-circle"></i>
                        <span>Conclusiones y recomendaciones</span>
                    </li>
                </ul>

                <div class="success-box">
                    <strong><i class="fas fa-check-circle"></i> ¬°Proceso completado!</strong><br>
                    Ya tienes un an√°lisis completo con Machine Learning de √∫ltima generaci√≥n.
                    El modelo XGBoost ha procesado {total_records:,} registros y est√° listo para ayudar
                    en la detecci√≥n de enfermedades cr√≥nicas.
                </div>
            </div>
        </div>

        <!-- CONCLUSI√ìN -->
        <div class="step-card" style="background: #1e1e1e; color: white; border: 1px solid #2a2a2a;">
            <div class="step-content">
                <h2 style="color: white; text-align: center; font-size: 2rem; margin-bottom: 20px; font-weight: 600;">
                    <i class="fas fa-graduation-cap"></i> Resumen del Proceso
                </h2>

                <div style="background: #0d0d0d; padding: 28px; border-radius: 8px; border: 1px solid #2a2a2a;">
                    <p style="font-size: 1.05rem; line-height: 1.8; text-align: center; font-weight: 400; color: #d0d0d0;">
                        El modelo XGBoost funcion√≥ creando <strong style="color: #ffffff;">300 √°rboles de decisi√≥n inteligentes</strong>
                        que aprendieron patrones de {total_records:,} pacientes. Us√≥ t√©cnicas avanzadas como
                        <strong style="color: #ffffff;">SMOTE</strong> para balancear datos y <strong style="color: #ffffff;">validaci√≥n cruzada</strong> para
                        asegurar resultados confiables. El resultado final tiene una precisi√≥n de
                        <strong style="color: #ffffff;">{accuracy:.1f}%</strong>, lo que significa que de cada 100 predicciones,
                        aproximadamente {int(accuracy)} son correctas.
                    </p>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="window.close()" style="
                        background: #2a2a2a;
                        color: #ffffff;
                        border: 1px solid #3a3a3a;
                        padding: 12px 32px;
                        font-size: 1rem;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 500;
                        transition: all 0.2s ease;
                        font-family: 'Inter', sans-serif;
                    " onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='#2a2a2a'">
                        <i class="fas fa-arrow-left"></i> Cerrar an√°lisis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {{
            0% {{ transform: rotate(0deg); }}
            100% {{ transform: rotate(360deg); }}
        }}
    </style>
</body>
</html>
"""

    return html


def generate_column_items(columns):
    """Genera items HTML para la lista de columnas"""
    items_html = ""
    for col in columns:
        items_html += f'<li class="feature-item"><i class="fas fa-table"></i> <span>{col}</span></li>\n'
    return items_html


def get_performance_message(accuracy):
    """Genera un mensaje personalizado seg√∫n la precisi√≥n"""
    if accuracy >= 90:
        return "¬°Excelente! Este es un rendimiento excepcional para un modelo m√©dico predictivo."
    elif accuracy >= 80:
        return "¬°Muy bueno! Este modelo tiene un rendimiento s√≥lido y confiable."
    elif accuracy >= 70:
        return "Buen rendimiento. El modelo es √∫til pero podr√≠a mejorarse con m√°s datos o ajustes."
    else:
        return "El rendimiento es aceptable, pero se recomienda revisar la calidad de los datos o ajustar par√°metros."
